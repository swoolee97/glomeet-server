<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.glomeet.mapper.MatchingMapper">
    <insert id="insertMatchingRoom">

    </insert>

    <delete id="deleteMatchingRoom">

    </delete>

    <insert id="insertMatchingUser">
        INSERT INTO chatRoom
        VALUES (#{chatRoomId}, #{userEmail})
    </insert>

    <insert id="insertChatMessages" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO matchingMessage (message, senderEmail, chatRoomId, sendAt)
        VALUES
        <foreach collection="matchingMessages" item="matchingMessage" separator=",">
            (#{matchingMessage.message}, #{matchingMessage.senderEmail}, #{matchingMessage.chatRoomId},
            #{matchingMessage.sendAt})
        </foreach>
    </insert>

    <select id="findMatchingRoomByEmail" resultType="java.lang.String">
        SELECT id
        FROM chatRoom
                 INNER JOIN chatUser
                            ON chatRoom.id = chatUser.chatRoomId
        WHERE chatUser.userEmail = #{email}
          AND chatRoom.roomStatus = 'ACTIVE'
    </select>

    <select id="findMatchingRoomInfoByEmail" resultMap="chatRoomInfo">
        select chatRoomId, userEmail
        from chatUser
        where userEmail != #{email}
          and chatRoomId in (select chatRoomId from chatUser
            where userEmail = #{email})
    </select>


    <resultMap id="chatRoomInfo" type="com.example.glomeet.dto.MatchingRoomInfoDTO">
        <id column="chatRoomId" property="id"/>
        <result column="message" property="message"/>
        <result column="sendAt" property="sendAt"/>
        <result column="userEmail" property="partnerEmail"/>
    </resultMap>

    <select id="findChatMessages" parameterType="com.example.glomeet.dto.MessageListRequestDTO">
        SELECT *
        FROM matchingMessage
        WHERE chatRoomId = #{chatRoomId}
    </select>

</mapper>
